<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Make Original Algorithm &mdash; SimpleDistributedRL 0.14.0.2 ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5c722782"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/translations.js?v=4dbe4bdc"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="Detailed Framework" href="framework_detail.html" />
    <link rel="prev" title="Make Original Environment" href="custom_env.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SimpleDistributedRL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtouse.html">How To Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Distributed Learning (Online)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Custom</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="custom_env.html">Make Original Environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Make Original Algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">概要</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">実装する各クラスの説明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#config">Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory">Memory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sequencememory">SequenceMemory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#experiencereplaybuffer">ExperienceReplayBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#priorityexperiencereplay">PriorityExperienceReplay</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#parameter">Parameter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trainer">Trainer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worker">Worker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#discreteactionworker">DiscreteActionWorker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#continuousactionworker">ContinuousActionWorker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rlworker">RLWorker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Worker共通のプロパティ・関数</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">自作アルゴリズムの登録</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q">実装例(Q学習)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="framework_detail.html">Detailed Framework</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="env_config.html">EnvConfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="rl_config.html">RLConfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="rl_config_tree.html">RLConfig Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html">Runner(Configuration related)</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html#runner-runtime-related">Runner(Runtime related)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ql.html">Q-Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/dqn.html">Deep Q-Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/agent57.html">Agent57</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ppo.html">PPO(Proximal Policy Optimization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ddpg.html">DDPG(Deep Deterministic Policy Gradient)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/sac.html">SAC(Soft-Actor-Critic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/dreamer_v3.html">DreamerV3</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SimpleDistributedRL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Make Original Algorithm</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/custom_algorithm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="make-original-algorithm">
<span id="custom-algorithm"></span><h1>Make Original Algorithm<a class="headerlink" href="#make-original-algorithm" title="Link to this heading"></a></h1>
<p>ここでは本フレームワークでの自作アルゴリズムを作成する方法を説明します。構成は以下です。</p>
<ol class="arabic simple">
<li><p>概要</p></li>
<li><dl class="simple">
<dt>実装するクラスの説明</dt><dd><ol class="arabic simple">
<li><p>Config</p></li>
<li><p>Memory</p></li>
<li><p>Parameter</p></li>
<li><p>Trainer</p></li>
<li><p>Worker</p></li>
</ol>
</dd>
</dl>
</li>
<li><p>自作アルゴリズムの登録</p></li>
<li><p>Q学習実装例</p></li>
</ol>
<section id="id1">
<h2>概要<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>自作アルゴリズムでは5つクラスを定義する必要があり、以下のように連携して動作します。(図にはないですが、他にハイパーパラメータを管理するConfigクラスがあります)</p>
<img alt="../_images/overview-sequence.drawio.png" src="../_images/overview-sequence.drawio.png" />
<div class="line-block">
<div class="line">WorkerRunとEnvRunはフレームワーク内の動作になるので意識する必要はありません。</div>
<div class="line">それぞれの役割は以下です。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Config</p></td>
<td><ul class="simple">
<li><p>ハイパーパラメータを管理するクラス</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Worker</p></td>
<td><ul class="simple">
<li><p>Environmentと連携しサンプルを収集</p></li>
<li><p>収集したサンプルをMemoryに送信（add only）</p></li>
<li><p>行動決定に必要な情報をParameterから読む（read only）</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Trainer</p></td>
<td><ul class="simple">
<li><p>Memoryからサンプルを取得し学習する</p></li>
<li><p>学習後、Parameterを更新する</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Memory</p></td>
<td><ul class="simple">
<li><p>サンプルを管理</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><ul class="simple">
<li><p>学習パラメータを保持</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>分散学習は以下となり各クラスが非同期で動作します。</p>
<img alt="../_images/overview-mp.drawio.png" src="../_images/overview-mp.drawio.png" />
<p>同期的な学習と以下の点が異なります。</p>
<ul class="simple">
<li><p>WorkerがMemoryにサンプルを送るタイミングとTrainerが取り出すタイミングが異なる</p></li>
<li><p>ParameterがWorkerとTrainerで同期されない</p></li>
</ul>
<p>各クラスの実装の仕方を見ていきます。</p>
</section>
<section id="id2">
<h2>実装する各クラスの説明<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="config">
<h3>Config<a class="headerlink" href="#config" title="Link to this heading"></a></h3>
<p>強化学習アルゴリズムの種類やハイパーパラメータを管理するクラスです。
基底クラスは <cite>srl.base.rl.base.RLConfig</cite> でこれを継承して作成します。</p>
<p>RLConfig で実装が必要な関数・プロパティは以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span> <span class="nn">srl.base.define</span> <span class="kn">import</span> <span class="n">RLBaseTypes</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.processor</span> <span class="kn">import</span> <span class="n">Processor</span>

<span class="c1"># 必ず dataclass で書いてください</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">):</span>

   <span class="c1"># コンストラクタで使うハイパーパラメータを定義する</span>

   <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; ユニークな名前を返す &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      アルゴリズムが想定するアクションのタイプを返してください。</span>
<span class="sd">      DISCRETE  : 離散値</span>
<span class="sd">      CONTINUOUS: 連続値</span>
<span class="sd">      ANY       : どちらでも</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      アルゴリズムが想定する環境から受け取る状態のタイプを返してください。</span>
<span class="sd">      DISCRETE  : 離散値</span>
<span class="sd">      CONTINUOUS: 連続値</span>
<span class="sd">      ANY       : どちらでも</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">get_use_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      使うフレームワークを指定してください。</span>
<span class="sd">      return &quot;&quot;           : 何もなし</span>
<span class="sd">      return &quot;tensorflow&quot; : Tensorflow</span>
<span class="sd">      return &quot;torch&quot;      : Torch</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># ------------------------------------</span>
   <span class="c1"># 以下は option です。（必須ではない）</span>
   <span class="c1"># ------------------------------------</span>
   <span class="k">def</span> <span class="nf">assert_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; パラメータのassertを記載 &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">assert_params</span><span class="p">()</span>  <span class="c1"># 親クラスも呼び出してください</span>

   <span class="k">def</span> <span class="nf">set_config_by_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">EnvRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; env初期化後に呼び出されます。env関係の初期化がある場合は記載してください。 &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span> <span class="nf">set_config_by_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 分散学習でactorが指定されたときに呼び出されます。Actor関係の初期化がある場合は記載してください。 &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span> <span class="nf">set_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Processor</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 前処理を追加したい場合設定してください &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
</section>
<section id="memory">
<h3>Memory<a class="headerlink" href="#memory" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Workerが取得したサンプル(batch)をTrainerに渡す役割を持っているクラスです。</div>
<div class="line">以下の3種類から継承します。</div>
<div class="line">（RLMemoryを直接継承することでオリジナルのMemoryを作成することも可能です）</div>
<div class="line">（オリジナルのMemoryの作成例は`srl.algorithms.world_models`の実装を参考にしてください）</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>SequenceMemory</p></td>
<td><p>来たサンプルを順序通りに取り出します。(Queueみたいな動作です)</p></td>
</tr>
<tr class="row-even"><td><p>ExperienceReplayBuffer</p></td>
<td><p>サンプルをランダムに取り出します。</p></td>
</tr>
<tr class="row-odd"><td><p>PriorityExperienceReplay</p></td>
<td><p>サンプルを優先順位に従い取り出します。</p></td>
</tr>
</tbody>
</table>
<section id="sequencememory">
<h4>SequenceMemory<a class="headerlink" href="#sequencememory" title="Link to this heading"></a></h4>
<p>順番通りにサンプルを取り出しますMemoryです。サンプルは取り出すとなくなります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.rl.memories.sequence_memory</span> <span class="kn">import</span> <span class="n">SequenceMemory</span>


<span class="k">class</span> <span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">SequenceMemory</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># 実行例</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>  <span class="c1"># [[1, 2], [2, 3], [3, 4]]</span>
</pre></div>
</div>
</section>
<section id="experiencereplaybuffer">
<h4>ExperienceReplayBuffer<a class="headerlink" href="#experiencereplaybuffer" title="Link to this heading"></a></h4>
<div class="line-block">
<div class="line">ランダムにサンプルを取り出すMemoryです。</div>
<div class="line">これを使う場合は、Configにも <cite>ExperienceReplayBufferConfig</cite> を継承する必要があります。</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">srl.base.define</span> <span class="kn">import</span> <span class="n">RLBaseTypes</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span> <span class="nn">srl.rl.memories.experience_replay_buffer</span> <span class="kn">import</span> <span class="n">ExperienceReplayBuffer</span><span class="p">,</span> <span class="n">ExperienceReplayBufferConfig</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">,</span> <span class="n">ExperienceReplayBufferConfig</span><span class="p">):</span>
    <span class="c1"># RLConfig に加え、ExperienceReplayBufferConfig も継承する</span>
    <span class="c1"># (順番は RLConfig -&gt; ExperienceReplayBufferConfig )</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MyConfig&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="k">def</span> <span class="nf">get_use_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">class</span> <span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">ExperienceReplayBuffer</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># 実行例</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="n">MyConfig</span><span class="p">())</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>  <span class="c1"># [3, 2]</span>
</pre></div>
</div>
</section>
<section id="priorityexperiencereplay">
<h4>PriorityExperienceReplay<a class="headerlink" href="#priorityexperiencereplay" title="Link to this heading"></a></h4>
<div class="line-block">
<div class="line">優先順位に従ってサンプルを取り出すMemoryです。</div>
<div class="line">これを使う場合は、Configにも <cite>PriorityExperienceReplayConfig</cite> を継承する必要があります。</div>
</div>
<p>PriorityExperienceReplayはConfigにより以下のアルゴリズムに切り替えることができます。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ReplayMemory</p></td>
<td><p>ExperienceReplayBufferと同じで、ランダムに取得します。（優先順位はありません）</p></td>
</tr>
<tr class="row-odd"><td><p>ProportionalMemory</p></td>
<td><p>サンプルの重要度によって確率が変わります。重要度が高いサンプルほど選ばれる確率が上がります。</p></td>
</tr>
<tr class="row-even"><td><p>RankBaseMemory</p></td>
<td><p>サンプルの重要度のランキングによって確率が変わります。重要度が高いサンプルほど選ばれる確率が上がるのはProportionalと同じです。</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">srl.base.define</span> <span class="kn">import</span> <span class="n">RLBaseTypes</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span> <span class="nn">srl.rl.memories.priority_experience_replay</span> <span class="kn">import</span> <span class="n">PriorityExperienceReplay</span><span class="p">,</span> <span class="n">PriorityExperienceReplayConfig</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">,</span> <span class="n">PriorityExperienceReplayConfig</span><span class="p">):</span>
    <span class="c1"># RLConfig PriorityExperienceReplayConfig も継承する</span>
    <span class="c1"># (順番は RLConfig -&gt; PriorityExperienceReplayConfig )</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MyConfig&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="k">def</span> <span class="nf">get_use_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">class</span> <span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">PriorityExperienceReplay</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># --- select memory</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">MyConfig</span><span class="p">()</span>
<span class="c1"># config.memory.set_replay_memory()</span>
<span class="n">config</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">set_proportional_memory</span><span class="p">()</span>
<span class="c1"># config.memory.set_rankbase_memory()</span>

<span class="c1"># --- run memory</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">indices</span><span class="p">,</span> <span class="n">batchs</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">batchs</span><span class="p">)</span>  <span class="c1"># [2]</span>
<span class="n">memory</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">indices</span><span class="p">,</span> <span class="n">batchs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">11</span><span class="p">])))</span>
</pre></div>
</div>
</section>
</section>
<section id="parameter">
<h3>Parameter<a class="headerlink" href="#parameter" title="Link to this heading"></a></h3>
<p>パラメータを管理するクラスです。深層学習の場合はここにニューラルネットワークを定義することを想定しています。</p>
<p>実装が必要な関数は以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLParameter</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">MyParameter</span><span class="p">(</span><span class="n">RLParameter</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; コントラクタの引数は親に渡してください &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

      <span class="c1"># self.config に上で定義した MyConfig が入ります</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span><span class="n">MyConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

   <span class="c1"># call_restore/call_backupでパラメータが復元できるように作成</span>
   <span class="k">def</span> <span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
   <span class="k">def</span> <span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># その他任意の関数を作成できます</span>
   <span class="c1"># （パラメータに関するTrainer/Workerで共通する処理など）</span>
</pre></div>
</div>
</section>
<section id="trainer">
<h3>Trainer<a class="headerlink" href="#trainer" title="Link to this heading"></a></h3>
<p>学習を定義する部分です。Memoryから経験を受け取ってParameterを更新します。</p>
<p>実装が必要な関数は以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLTrainer</span>

<span class="k">class</span> <span class="nc">MyTrainer</span><span class="p">(</span><span class="n">RLTrainer</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; コントラクタの引数は親に渡してください &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

      <span class="c1"># config,parameter がそれぞれ入ります。</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">MyConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">MyParameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span> <span class="n">IRLMemoryTrainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>

   <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      self.memory から batch を受け取り学習を定義します。</span>
<span class="sd">      self.memory は以下の関数が定義されています。</span>

<span class="sd">      self.memory.is_warmup_needed() : warmup中かどうかを返します</span>
<span class="sd">      self.memory.sample(self.batch_size, self.train_count) : batchを返します</span>
<span class="sd">      self.memory.update(memory_update_args) : ProportionalMemory の場合 update で使います</span>

<span class="sd">      ・学習したら回数を数えてください</span>
<span class="sd">      self.train_count += 1</span>

<span class="sd">      ・(option)必要に応じてinfoを設定します</span>
<span class="sd">      self.train_info = {&quot;loss&quot;: 0.0}</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="worker">
<h3>Worker<a class="headerlink" href="#worker" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">実際に環境と連携して経験を収集するクラスです。</div>
<div class="line">役割は、Parameterを参照してアクションを決める事と、サンプルをMemoryに送信する事です。</div>
</div>
<p>RLWorkerとRLTrainerのフローをすごく簡単に書くと以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">worker</span><span class="o">.</span><span class="n">on_reset</span><span class="p">()</span>
<span class="k">while</span><span class="p">:</span>
   <span class="n">action</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">policy</span><span class="p">()</span>
   <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
   <span class="n">worker</span><span class="o">.</span><span class="n">on_step</span><span class="p">()</span>
   <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">RLWorkerはアルゴリズムに合わせたインタフェースのクラスを用意しています。</div>
<div class="line">基本はそちらを使用してください。</div>
<div class="line">現状あるクラスは以下です。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 55%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DiscreteActionWorker</p></td>
<td><p>モデルフリーでアクションが離散値のアルゴリズム</p></td>
<td><p>Q学習,DQN等</p></td>
</tr>
<tr class="row-odd"><td><p>ContinuousActionWorker</p></td>
<td><p>モデルフリーでアクションが連続値のアルゴリズム</p></td>
<td><p>DDPG,SAC等</p></td>
</tr>
<tr class="row-even"><td><p>RLWorker</p></td>
<td><p>上記以外のアルゴリズム</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>EnvWorker</p></td>
<td><p>Envと直接やり取りするアルゴリズム（ルールベース等）</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>ExtendWorker</p></td>
<td><p>RLWorkerとルールベースを混ぜて使う用</p></td>
<td></td>
</tr>
</tbody>
</table>
<section id="discreteactionworker">
<h4>DiscreteActionWorker<a class="headerlink" href="#discreteactionworker" title="Link to this heading"></a></h4>
<p>DiscreteActionWorkerで実装が必要な関数は以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.algorithms.discrete_action</span> <span class="kn">import</span> <span class="n">DiscreteActionWorker</span>

<span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">DiscreteActionWorker</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; コントラクタの引数は親に渡してください &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

      <span class="c1"># config,parameter,memory がそれぞれ入ります。</span>
      <span class="c1"># memoryはaddしか使えません。</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">MyConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">MyParameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span> <span class="n">IRLMemoryWorker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>

   <span class="k">def</span> <span class="nf">call_on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; エピソードの最初に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            state (np.ndarray): 環境の初期状態</span>
<span class="sd">            invalid_actions (List[int]): 初期状態での有効でないアクションのリスト</span>

<span class="sd">      Returns:</span>
<span class="sd">            Info: 任意の情報</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; このターンで実行するアクションを返す関数</span>

<span class="sd">      Args:</span>
<span class="sd">            state (np.ndarray): 現在の状態</span>
<span class="sd">            invalid_actions (List[int]): 現在の有効でないアクションのリスト</span>

<span class="sd">      Returns: (</span>
<span class="sd">            int : 実行するアクション</span>
<span class="sd">            Info: 任意の情報</span>
<span class="sd">      )</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_on_step</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">next_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
      <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
      <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
      <span class="n">next_invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
   <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Envが1step実行した後に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            next_state (np.ndarray): アクション実行後の状態</span>
<span class="sd">            reward (float): アクション実行後の報酬</span>
<span class="sd">            done (bool): アクション実行後の終了状態</span>
<span class="sd">            next_invalid_actions (List[int]): アクション実行後の有効でないアクションのリスト</span>

<span class="sd">      Returns:</span>
<span class="sd">            dict: 情報(任意)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="continuousactionworker">
<h4>ContinuousActionWorker<a class="headerlink" href="#continuousactionworker" title="Link to this heading"></a></h4>
<p>ContinuousActionWorkerで実装が必要な関数は以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.algorithms.continuous_action</span> <span class="kn">import</span> <span class="n">ContinuousActionWorker</span>

<span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">ContinuousActionWorker</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; コントラクタの引数は親に渡してください &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

      <span class="c1"># config,parameter,memory がそれぞれ入ります。</span>
      <span class="c1"># memoryはaddしか使えません。</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">MyConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">MyParameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span> <span class="n">IRLMemoryWorker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>

   <span class="k">def</span> <span class="nf">call_on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Info</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; エピソードの最初に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            state (np.ndarray): 環境の初期状態</span>

<span class="sd">      Returns:</span>
<span class="sd">            Info: 任意の情報</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Info</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; このターンで実行するアクションを返す関数</span>

<span class="sd">      Args:</span>
<span class="sd">            state (np.ndarray): 現在の状態</span>

<span class="sd">      Returns: (</span>
<span class="sd">            List[float]: 実行するアクション(小数の配列)</span>
<span class="sd">            Info       : 任意の情報</span>
<span class="sd">      )</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Envが1step実行した後に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            next_state (np.ndarray): アクション実行後の状態</span>
<span class="sd">            reward (float): アクション実行後の報酬</span>
<span class="sd">            done (bool): アクション実行後の終了状態</span>

<span class="sd">      Returns:</span>
<span class="sd">            dict: 情報(任意)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="rlworker">
<h4>RLWorker<a class="headerlink" href="#rlworker" title="Link to this heading"></a></h4>
<p>RLWorker は実行時のクラスである WorkerRun を直接操作して実装するクラスです。
出来ることが多いのと、仕様が変わる可能性大きいので詳細は一旦保留します。(TODO)</p>
<p>実装が必要な関数は以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.algorithms.modelbase</span> <span class="kn">import</span> <span class="n">ModelBaseWorker</span>

<span class="kn">from</span> <span class="nn">srl.base.env.env_run</span> <span class="kn">import</span> <span class="n">EnvRun</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.worker</span> <span class="kn">import</span> <span class="n">RLWorker</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.worker_run</span> <span class="kn">import</span> <span class="n">WorkerRun</span>

<span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">ModelBaseWorker</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; コントラクタの引数は親に渡してください &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

      <span class="c1"># config,parameter,memory がそれぞれ入ります。</span>
      <span class="c1"># memoryはaddしか使えません。</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">MyConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">MyParameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span> <span class="n">IRLMemoryWorker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>

   <span class="k">def</span> <span class="nf">call_on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; エピソードの最初に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            worker: WorkerRun</span>

<span class="sd">      Returns:</span>
<span class="sd">            Info: 任意の情報</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">state</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RLActionType</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; このターンで実行するアクションを返す関数</span>

<span class="sd">      Args:</span>
<span class="sd">            worker: WorkerRun</span>

<span class="sd">      Returns: (</span>
<span class="sd">            RLAction: 実行するアクション</span>
<span class="sd">            Info    : 任意の情報</span>
<span class="sd">      )</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">call_on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Envが1step実行した後に呼ばれる関数</span>

<span class="sd">      Args:</span>
<span class="sd">            worker: WorkerRun</span>

<span class="sd">      Returns:</span>
<span class="sd">            dict: 情報(任意)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">next_state</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">state</span>
      <span class="n">reward</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">reward</span>
      <span class="n">done</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">done</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>Worker共通のプロパティ・関数<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<p>Workerで共通して持っているプロパティ・関数は以下となります。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">srl.base.define</span> <span class="kn">import</span> <span class="n">RLAction</span>

<span class="k">class</span> <span class="nc">RLWorker</span><span class="p">:</span>
   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; training かどうかを返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">distributed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 分散実行中かどうかを返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distributed</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">rendering</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; renderがあるエピソードかどうかを返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rendering</span>

   <span class="k">def</span> <span class="nf">render_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      描画用の関数です。</span>
<span class="sd">      実装するとrenderによる描画が可能になります。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span> <span class="nf">render_rgb_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      描画用の関数です。</span>
<span class="sd">      実装するとrenderによる描画が可能になります。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="kc">None</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">player_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 複数人実行する環境にて、自分のプレイヤー番号を返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_player_index</span>

   <span class="k">def</span> <span class="nf">get_invalid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RLAction</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 有効でないアクションを返します(離散限定) &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">invalid_actions</span>

   <span class="k">def</span> <span class="nf">sample_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLAction</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; ランダムなアクションを返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">action</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">max_episode_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 最大steps数を返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__worker_run</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">max_episode_steps</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">player_num</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; プレイヤー数を返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__worker_run</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">player_num</span>

   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 現在のstepを返します &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__worker_run</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">step_num</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id4">
<h2>自作アルゴリズムの登録<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<p>以下で登録します。
第2引数以降の entry_point は、<cite>モジュールパス + &quot;:&quot; + クラス名`で、
モジュールパスは `importlib.import_module</cite> で呼び出せる形式である必要があります。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">srl.base.rl.registration</span> <span class="kn">import</span> <span class="n">register</span>
<span class="n">register</span><span class="p">(</span>
   <span class="n">MyConfig</span><span class="p">(),</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyMemory&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyParameter&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyTrainer&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyWorker&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="q">
<h2>実装例(Q学習)<a class="headerlink" href="#q" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">srl.base.define</span> <span class="kn">import</span> <span class="n">RLBaseTypes</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.algorithms.discrete_action</span> <span class="kn">import</span> <span class="n">DiscreteActionWorker</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.base</span> <span class="kn">import</span> <span class="n">RLParameter</span><span class="p">,</span> <span class="n">RLTrainer</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.config</span> <span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span> <span class="nn">srl.base.rl.registration</span> <span class="kn">import</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">srl.rl.memories.sequence_memory</span> <span class="kn">import</span> <span class="n">SequenceMemory</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">):</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">test_epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="k">def</span> <span class="nf">get_use_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MyRL&quot;</span>


<span class="k">class</span> <span class="nc">Memory</span><span class="p">(</span><span class="n">SequenceMemory</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">RLParameter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Q学習用のテーブル</span>

    <span class="k">def</span> <span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>

    <span class="c1"># Q値を取得する関数</span>
    <span class="k">def</span> <span class="nf">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_num</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">RLTrainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">Parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">is_warmup_needed</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">batchs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_count</span><span class="p">)</span>

        <span class="n">td_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batchs</span><span class="p">:</span>
            <span class="c1"># 各batch毎にQテーブルを更新する</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
            <span class="n">n_s</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;next_state&quot;</span><span class="p">]</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;done&quot;</span><span class="p">]</span>

            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="n">n_s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_q</span><span class="p">)</span>

            <span class="n">td_error</span> <span class="o">=</span> <span class="n">target_q</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
            <span class="n">q</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="n">td_error</span>

            <span class="n">td_error</span> <span class="o">+=</span> <span class="n">td_error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 学習回数</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batchs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">td_error</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batchs</span><span class="p">)</span>

        <span class="c1"># 学習結果(任意)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">Q</span><span class="p">),</span>
            <span class="s2">&quot;td_error&quot;</span><span class="p">:</span> <span class="n">td_error</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">DiscreteActionWorker</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">:</span> <span class="n">Parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span>

    <span class="k">def</span> <span class="nf">call_on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">call_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># 学習中かどうかで探索率を変える</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_epsilon</span>

        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="c1"># epsilonより低いならランダムに移動</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_action</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

            <span class="c1"># 最大値を選ぶ（複数あればランダム）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">),</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">call_on_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">next_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">next_invalid_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;next_state&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_state</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">reward</span><span class="p">,</span>
            <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">done</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># memoryはaddのみ</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># 強化学習の可視化用、今回ですとQテーブルを表示しています。</span>
    <span class="k">def</span> <span class="nf">render_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="n">maxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_num</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">maxa</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_to_str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="si">:</span><span class="s2">7.5f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="c1"># ---------------------------------</span>
<span class="c1"># 登録</span>
<span class="c1"># ---------------------------------</span>
<span class="n">register</span><span class="p">(</span>
    <span class="n">Config</span><span class="p">(),</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Memory&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Parameter&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Trainer&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Worker&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># ---------------------------------</span>
<span class="c1"># テスト</span>
<span class="c1"># ---------------------------------</span>
<span class="kn">from</span> <span class="nn">srl.test</span> <span class="kn">import</span> <span class="n">TestRL</span>

<span class="n">tester</span> <span class="o">=</span> <span class="n">TestRL</span><span class="p">()</span>
<span class="n">tester</span><span class="o">.</span><span class="n">simple_check</span><span class="p">(</span><span class="n">Config</span><span class="p">())</span>


<span class="c1"># ---------------------------------</span>
<span class="c1"># Grid環境の学習</span>
<span class="c1"># ---------------------------------</span>
<span class="kn">import</span> <span class="nn">srl</span>

<span class="n">runner</span> <span class="o">=</span> <span class="n">srl</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="n">srl</span><span class="o">.</span><span class="n">EnvConfig</span><span class="p">(</span><span class="s2">&quot;Grid&quot;</span><span class="p">),</span> <span class="n">Config</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">))</span>

<span class="c1"># --- train</span>
<span class="n">runner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># --- test</span>
<span class="n">rewards</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">max_episodes</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;100エピソードの平均結果&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>

<span class="n">runner</span><span class="o">.</span><span class="n">render_terminal</span><span class="p">()</span>

<span class="n">runner</span><span class="o">.</span><span class="n">animation_save_gif</span><span class="p">(</span><span class="s2">&quot;_MyRL-Grid.gif&quot;</span><span class="p">,</span> <span class="n">render_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>renderの表示例</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>### 0, action None, rewards[0.000] (0.0s)
env   {}
work0 None
......
.   G.
. . X.
.P   .
......

←: 0.17756
↓: 0.16355
→: 0.11174
*↑: 0.37473
### 1, action 3(↑), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
.   G.
.P. X.
.    .
......

←: 0.27779
↓: 0.20577
→: 0.27886
*↑: 0.49146
### 2, action 3(↑), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
.P  G.
. . X.
.    .
......

←: 0.34255
↓: 0.29609
*→: 0.61361
↑: 0.34684
### 3, action 2(→), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
.   G.
.P. X.
.    .
......

←: 0.27779
↓: 0.20577
→: 0.27886
*↑: 0.49146
### 4, action 3(↑), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
.P  G.
. . X.
.    .
......

←: 0.34255
↓: 0.29609
*→: 0.61361
↑: 0.34684
### 5, action 2(→), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
. P G.
. . X.
.    .
......

←: 0.37910
↓: 0.44334
*→: 0.76733
↑: 0.46368
### 6, action 2(→), rewards[-0.040] (0.0s)
env   {}
work0 {}
......
.  PG.
. . X.
.    .
......

←: 0.47941
↓: 0.39324
*→: 0.92425
↑: 0.59087
### 7, action 2(→), rewards[1.000], done(env) (0.0s)
env   {}
work0 {}
......
.   P.
. . X.
.    .
......

[0.760000005364418]
</pre></div>
</div>
<img alt="../_images/custom_algorithm4.gif" src="../_images/custom_algorithm4.gif" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom_env.html" class="btn btn-neutral float-left" title="Make Original Environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="framework_detail.html" class="btn btn-neutral float-right" title="Detailed Framework" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, poco_cpp.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>