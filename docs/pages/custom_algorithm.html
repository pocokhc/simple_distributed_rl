

<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Making a Custom algorithm &mdash; SimpleDistributedRL 1.0.0 ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=144c8c96"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=4755f45a"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="Detailed Framework" href="framework_detail.html" />
    <link rel="prev" title="Making a Custom environment" href="custom_env.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SimpleDistributedRL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtouse.html">How To Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Distributed Learning (Online)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Custom</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="custom_env.html">Making a Custom environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Making a Custom algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">1. 概要</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">2. 実装する各クラスの説明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#config">2-1. Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory">2-2. Memory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rlsingleusebuffer">RLSingleUseBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rlreplaybuffer">RLReplayBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rlpriorityreplaybuffer">RLPriorityReplayBuffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">オリジナルMemoryの作成</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#parameter">2-3. Parameter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trainer">2-4. Trainer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worker">2-5. Worker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">3. 自作アルゴリズムの登録</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">4. 型ヒント</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q">5. 実装例(Q学習)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="framework_detail.html">Detailed Framework</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="env_config.html">EnvConfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="rl_config.html">RLConfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="rl_config_tree.html">RLConfig Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html">Runner(Configuration related)</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html#runner-train-related">Runner(Train related)</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html#runner-runtime-related">Runner(Runtime related)</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner.html#runner-distribution-related">Runner(Distribution related)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ql.html">Q-Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/dqn.html">Deep Q-Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/rainbow.html">Rainbow</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/agent57.html">Agent57</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/agent57_light.html">Agent57 light</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ppo.html">PPO(Proximal Policy Optimization)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/ddpg.html">DDPG(Deep Deterministic Policy Gradient)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/sac.html">SAC(Soft-Actor-Critic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/snd.html">SND(Self-supervised Network Distillation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/mcts.html">Monte Carlo tree search</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/alphazero.html">AlphaZero</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/muzero.html">MuZero</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/dreamer_v3.html">DreamerV3</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SimpleDistributedRL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Making a Custom algorithm</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/custom_algorithm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="making-a-custom-algorithm">
<span id="custom-algorithm"></span><h1>Making a Custom algorithm<a class="headerlink" href="#making-a-custom-algorithm" title="Link to this heading"></a></h1>
<p>ここでは本フレームワークの自作アルゴリズムを作成する方法を説明します。</p>
<ul class="simple">
<li><p>1.概要</p></li>
<li><dl class="simple">
<dt>2.実装するクラス</dt><dd><ul>
<li><p>2-1.Config</p></li>
<li><p>2-2.Memory</p></li>
<li><p>2-3.Parameter</p></li>
<li><p>2-4.Trainer</p></li>
<li><p>2-5.Worker</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>3.自作アルゴリズムの登録</p></li>
<li><p>4.型ヒント</p></li>
<li><p>5.Q学習実装例</p></li>
</ul>
<section id="id1">
<h2>1. 概要<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">自作アルゴリズムは5つのクラスが以下のように連携して動作します。</div>
<div class="line">※図にはないですが、他にハイパーパラメータを管理するConfigクラスがあります</div>
<div class="line">※WorkerRunとEnvRunはフレームワーク内の内容になるので意識する必要はありません</div>
</div>
<img alt="../_images/overview-sequence.drawio.png" src="../_images/overview-sequence.drawio.png" />
<div class="line-block">
<div class="line">実装側で意識する疑似コードは以下です。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 学習単位の初期化</span>
<span class="n">parameter</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
<span class="n">memory</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
<span class="n">worker</span><span class="o">.</span><span class="n">on_setup</span><span class="p">()</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">on_setup</span><span class="p">()</span>

<span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
   <span class="c1"># 1エピソード最初の初期化</span>
   <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
   <span class="n">worker</span><span class="o">.</span><span class="n">on_reset</span><span class="p">()</span>

   <span class="c1"># 1エピソードのループ</span>
   <span class="k">while</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
         <span class="c1"># アクションを取得</span>
         <span class="n">action</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">policy</span><span class="p">()</span>
         <span class="n">worker</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>  <span class="c1"># workerの描画</span>

         <span class="c1"># 環境の1stepを実行</span>
         <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
         <span class="n">worker</span><span class="o">.</span><span class="n">on_step</span><span class="p">()</span>

         <span class="c1"># 学習</span>
         <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

   <span class="c1"># 終了後の描画</span>
   <span class="n">worker</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1"># 学習単位の終了</span>
<span class="n">worker</span><span class="o">.</span><span class="n">on_teardown</span><span class="p">()</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">on_teardown</span><span class="p">()</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">それぞれの役割は以下です。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 21.1%" />
<col style="width: 78.9%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Config</p></td>
<td><ul class="simple">
<li><p>ハイパーパラメータを管理</p></li>
<li><p>実行時のSpace情報を管理</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Memory</p></td>
<td><ul class="simple">
<li><p>Workerが収集したサンプルを管理</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><ul class="simple">
<li><p>学習パラメータを保持</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Trainer</p></td>
<td><ul class="simple">
<li><p>Memoryからサンプルを取得し学習する</p></li>
<li><p>学習後、Parameterを更新する</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Worker</p></td>
<td><ul class="simple">
<li><p>Environmentと連携しサンプルを収集</p></li>
<li><p>収集したサンプルをMemoryに送信</p></li>
<li><p>行動決定に必要な情報をParameterから読む</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>分散学習は以下となり各クラスが非同期で動作します。</p>
<p>・MemoryとTrainerが非同期</p>
<img alt="../_images/overview-mp_memory.drawio.png" src="../_images/overview-mp_memory.drawio.png" />
<p>・MemoryとTrainerが同期</p>
<img alt="../_images/overview-mp.drawio.png" src="../_images/overview-mp.drawio.png" />
<p>同期的な学習と以下の点が異なります。</p>
<ul class="simple">
<li><p>WorkerがMemoryにサンプルを送るタイミングとTrainerが取り出すタイミングが異なる</p></li>
<li><p>ParameterがWorkerとTrainerで別インスタンス</p></li>
</ul>
<p>各クラスの実装の仕方を見ていきます。</p>
</section>
<section id="id2">
<h2>2. 実装する各クラスの説明<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="config">
<h3>2-1. Config<a class="headerlink" href="#config" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">強化学習アルゴリズムの種類やハイパーパラメータを管理するクラスです。</div>
<div class="line">基底クラスは <cite>srl.base.rl.base.RLConfig</cite> でこれを継承して作成します。</div>
<div class="line"><br /></div>
<div class="line">RLConfig で実装が必要な関数・プロパティは以下です。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.define</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLBaseActTypes</span><span class="p">,</span> <span class="n">RLBaseObsTypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Processor</span>

<span class="c1"># 必ず dataclass で書いてください</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">):</span>

   <span class="c1"># 任意のハイパーパラメータを定義</span>
   <span class="n">hoo_param</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">bar_param</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; ユニークな名前を返す &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">get_base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseActTypes</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      アルゴリズムが想定するアクションのタイプ(srl.base.define.RLBaseActTypes)を返してください。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">get_base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseObsTypes</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      アルゴリズムが想定する環境から受け取る状態のタイプ(srl.base.define.RLBaseObsTypes)を返してください。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># ------------------------------------</span>
   <span class="c1"># 以下は option です。（なくても問題ありません）</span>
   <span class="c1"># ------------------------------------</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">get_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      使うフレームワークを指定してください。</span>
<span class="sd">      return &quot;&quot;           : なし(default)</span>
<span class="sd">      return &quot;tensorflow&quot; : Tensorflow</span>
<span class="sd">      return &quot;torch&quot;      : Torch</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">validate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; パラメータのassertを記載 &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_params</span><span class="p">()</span>  <span class="c1"># 定義する場合は親クラスも呼び出してください</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">setup_from_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">EnvRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; env初期化後に呼び出されます。env関係の初期化がある場合は記載してください。 &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">setup_from_actor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">actor_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 分散学習でactorが指定されたときに呼び出されます。Actor関係の初期化がある場合は記載してください。 &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">get_processors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_observation_space</span><span class="p">:</span> <span class="n">SpaceBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RLProcessor</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 前処理を追加したい場合設定してください &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="p">[]</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">use_backup_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; MCTSなど、envのbackup/restoreを使う場合はTrueを返してください&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="kc">False</span>

   <span class="c1"># use_render_image_stateをTrueにするとworker.render_img_stateが有効になります</span>
   <span class="c1"># これはenv.render_rgb_arrayの画像が入ります</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">use_render_image_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">get_render_image_processors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_observation_space</span><span class="p">:</span> <span class="n">SpaceBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RLProcessor</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;render_img_stateに対する前処理&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>※ __post_init__ の利用はコンストラクタの値が上書きされるので非推奨です。</p>
</section>
<section id="memory">
<h3>2-2. Memory<a class="headerlink" href="#memory" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Workerが取得したサンプル(batch)をTrainerに渡す役割を持っているクラスです。</div>
<div class="line">以下の3種類から継承すると簡単です。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 66.7%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>SingleUseBuffer</p></td>
<td><p>来たサンプルを順序通りに取り出します。(Queueみたいな動作です)</p></td>
</tr>
<tr class="row-even"><td><p>ReplayBuffer</p></td>
<td><p>サンプルをランダムに取り出します。</p></td>
</tr>
<tr class="row-odd"><td><p>PriorityReplayBuffer</p></td>
<td><p>サンプルを優先順位に従い取り出します。</p></td>
</tr>
</tbody>
</table>
<section id="rlsingleusebuffer">
<h4>RLSingleUseBuffer<a class="headerlink" href="#rlsingleusebuffer" title="Link to this heading"></a></h4>
<p>順番通りにサンプルを取り出しますMemoryです。サンプルは取り出すとなくなります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyRLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.rl.memories.single_use_buffer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLSingleUseBuffer</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">RLSingleUseBuffer</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="n">DummyRLConfig</span><span class="p">())</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>  <span class="c1"># [[1, 2], [2, 3], [3, 4]]</span>
</pre></div>
</div>
</section>
<section id="rlreplaybuffer">
<h4>RLReplayBuffer<a class="headerlink" href="#rlreplaybuffer" title="Link to this heading"></a></h4>
<div class="line-block">
<div class="line">ランダムにサンプルを取り出すMemoryです。</div>
<div class="line">これを使う場合は Configに <cite>batch_size</cite> と <cite>ReplayBufferConfig</cite> を実装する必要があります。</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyRLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.rl.memories.replay_buffer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplayBufferConfig</span><span class="p">,</span> <span class="n">RLReplayBuffer</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">DummyRLConfig</span><span class="p">):</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># batch_sizeを実装する必要あり</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">ReplayBufferConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ReplayBufferConfig</span><span class="p">(</span>
            <span class="n">warmup_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">RLReplayBuffer</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="n">MyConfig</span><span class="p">())</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>  <span class="c1"># [3, 2]</span>
</pre></div>
</div>
</section>
<section id="rlpriorityreplaybuffer">
<h4>RLPriorityReplayBuffer<a class="headerlink" href="#rlpriorityreplaybuffer" title="Link to this heading"></a></h4>
<div class="line-block">
<div class="line">優先順位に従ってサンプルを取り出すMemoryです。</div>
<div class="line">これを使う場合は Configに <cite>batch_size</cite> と <cite>PriorityReplayBufferConfig</cite> を実装する必要があります。</div>
<div class="line">また、このアルゴリズムはConfigのset関数により切り替えることができます。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 23.1%" />
<col style="width: 76.9%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>クラス名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>set_replay_buffer</p></td>
<td><p>ReplayBufferと同じで、ランダムに取得します。（優先順位はありません）</p></td>
</tr>
<tr class="row-odd"><td><p>set_proportional</p></td>
<td><p>サンプルの重要度によって確率が変わります。重要度が高いサンプルほど選ばれる確率が上がります。</p></td>
</tr>
<tr class="row-even"><td><p>set_rankbased</p></td>
<td><p>サンプルの重要度のランキングによって確率が変わります。重要度が高いサンプルほど選ばれる確率が上がるのはProportionalと同じです。</p></td>
</tr>
<tr class="row-odd"><td><p>set_rankbased_linear</p></td>
<td><p>rankbasedと同じですが、指数的な計算で複雑なrankbasedをlinearを仮定することで高速化したアルゴリズムです。</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyRLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.rl.memories.priority_replay_buffer</span><span class="w"> </span><span class="kn">import</span> <span class="n">PriorityReplayBufferConfig</span><span class="p">,</span> <span class="n">RLPriorityReplayBuffer</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">DummyRLConfig</span><span class="p">):</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># batch_sizeを実装する必要あり</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">PriorityReplayBufferConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">PriorityReplayBufferConfig</span><span class="p">(</span>
            <span class="n">warmup_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyRemoteMemory</span><span class="p">(</span><span class="n">RLPriorityReplayBuffer</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">MyConfig</span><span class="p">()</span>

<span class="c1"># --- select memory</span>
<span class="c1"># config.memory.set_replay_buffer()</span>
<span class="n">config</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">set_proportional</span><span class="p">()</span>
<span class="c1"># config.memory.set_proportional_cpp()</span>
<span class="c1"># config.memory.set_rankbased()</span>
<span class="c1"># config.memory.set_rankbased_linear()</span>


<span class="c1"># --- run memory</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">MyRemoteMemory</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">batches</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">update_args</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>  <span class="c1"># [3, 1]</span>
<span class="n">memory</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">update_args</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>オリジナルMemoryの作成<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<div class="line-block">
<div class="line">RLMemoryを継承して実装します。</div>
<div class="line">実装後にWorker/Trainerとやり取りする関数を登録します。</div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 66.7%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>register_worker_func</p></td>
<td><p>Worker -&gt; Memory の関数を登録します。</p></td>
</tr>
<tr class="row-even"><td><p>register_trainer_recv_func</p></td>
<td><p>Memory -&gt; Trainer の関数を登録します。</p></td>
</tr>
<tr class="row-odd"><td><p>register_trainer_send_func</p></td>
<td><p>Trainer -&gt; Memory の関数を登録します。</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLMemory</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyMemory</span><span class="p">(</span><span class="n">RLMemory</span><span class="p">):</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># self.config に上で定義した MyConfig が入っています</span>

      <span class="c1"># Worker -&gt; Memory用の関数を登録、同時にシリアライズ用の関数も指定する必要あり</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_worker_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">)</span>

      <span class="c1"># Memory -&gt; Trainer用の関数を登録</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_trainer_recv_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>

      <span class="c1"># Trainer -&gt; Memory用の関数を登録</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_trainer_send_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># Worker-&gt;Memory関数は引数に serialized を持つ必要があり、</span>
      <span class="c1">#   Trueの場合、シリアライズされたデータになっている。</span>
      <span class="k">if</span> <span class="n">serialized</span><span class="p">:</span>
         <span class="n">batch</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># デシリアライズ例</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
      <span class="c1"># Worker-&gt;Memoryのデータをシリアライズする関数</span>
      <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># シリアライズ例</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
      <span class="c1"># 引数はなし</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># オプションですが、定義すると表示してくれます。</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

   <span class="c1"># call_restore/call_backupでパラメータが復元できるように作成</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># その他任意の関数を作成できます。</span>
</pre></div>
</div>
<p>※ v0.19.0 より <cite>__init__</cite> の使用は非推奨となりました。代わりにsetupを使ってください。</p>
</section>
</section>
<section id="parameter">
<h3>2-3. Parameter<a class="headerlink" href="#parameter" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">パラメータを管理するクラスです。</div>
<div class="line">深層学習の場合はここにニューラルネットワークを定義することを想定しています。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLParameter</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyParameter</span><span class="p">(</span><span class="n">RLParameter</span><span class="p">):</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># self.config に上で定義した MyConfig が入っています</span>
      <span class="k">pass</span>

   <span class="c1"># call_restore/call_backupでパラメータが復元できるように作成</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="c1"># その他任意の関数を作成できます。</span>
   <span class="c1"># 分散学習ではTrainer/Worker間で値を保持できない点に注意（backup/restoreした値のみ共有されます）</span>
</pre></div>
</div>
<p>※ v0.19.0 より <cite>__init__</cite> の使用は非推奨となりました。代わりにsetupを使ってください。</p>
</section>
<section id="trainer">
<h3>2-4. Trainer<a class="headerlink" href="#trainer" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">学習を定義する部分です。</div>
<div class="line">Memoryから経験を受け取ってParameterを更新します。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLTrainer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTrainer</span><span class="p">(</span><span class="n">RLTrainer</span><span class="p">):</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">on_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># 以下の変数を持ちます。</span>
      <span class="c1"># self.config: MyConfig</span>
      <span class="c1"># self.parameter: MyParameter</span>
      <span class="c1"># self.memory: MyMemory</span>
      <span class="c1">#</span>
      <span class="c1"># 他にも以下のプロパティが使えます</span>
      <span class="c1"># self.distributed  - property, bool : 分散実行中かどうかを返します</span>
      <span class="c1"># self.train_only   - property, bool : 学習のみかどうかを返します</span>
      <span class="c1">#</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      self.memory から batch を受け取り学習する事を想定しています。</span>

<span class="sd">      ・学習したら回数を数えてください</span>
<span class="sd">      self.train_count += 1</span>

<span class="sd">      ・(option)必要に応じてinfoを設定します</span>
<span class="sd">      self.info = {&quot;loss&quot;: 0.0}</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>※ v0.19.0 より <cite>__init__</cite> の使用は非推奨となりました。代わりにon_setupを使ってください。</p>
</section>
<section id="worker">
<h3>2-5. Worker<a class="headerlink" href="#worker" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">実際に環境と連携して経験を収集するクラスです。</div>
<div class="line">役割は、Parameterを参照してアクションを決める事と、サンプルをMemoryに送信する事です。</div>
</div>
<p>フローをすごく簡単に書くと以下です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">worker</span><span class="o">.</span><span class="n">on_reset</span><span class="p">()</span>
<span class="k">while</span><span class="p">:</span>
   <span class="n">action</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">policy</span><span class="p">()</span>
   <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
   <span class="n">worker</span><span class="o">.</span><span class="n">on_step</span><span class="p">()</span>
   <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLWorker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.worker_run</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkerRun</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyWorker</span><span class="p">(</span><span class="n">RLWorker</span><span class="p">):</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">on_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">RunContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># 以下の変数を持ちます。</span>
      <span class="c1"># self.config: MyConfig</span>
      <span class="c1"># self.parameter: MyParameter</span>
      <span class="c1"># self.memory: MyMemory</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">on_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; エピソードの最初に呼ばれる関数 &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLActionType</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; このターンで実行するアクションを返す関数、この関数のみ実装が必須になります</span>

<span class="sd">      Returns:</span>
<span class="sd">            RLActionType : 実行するアクション</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">WorkerRun</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Envが1step実行した後に呼ばれる関数 &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">render_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      描画用の関数です。</span>
<span class="sd">      実装するとrenderによる描画が可能になります。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">render_rgb_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      描画用の関数です。</span>
<span class="sd">      実装するとrenderによる描画が可能になります。</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># --- 実装時に関数内で使う事を想定しているプロパティ・関数となります</span>
<span class="bp">self</span><span class="o">.</span><span class="n">training</span>     <span class="c1"># property, bool : training かどうかを返します</span>
<span class="bp">self</span><span class="o">.</span><span class="n">distributed</span>  <span class="c1"># property, bool : 分散実行中かどうかを返します</span>
<span class="bp">self</span><span class="o">.</span><span class="n">rendering</span>    <span class="c1"># property, bool : renderがあるエピソードかどうかを返します</span>
<span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span>     <span class="c1"># property , SpaceBase : RLWorkerが受け取るobservation_spaceを返します</span>
<span class="bp">self</span><span class="o">.</span><span class="n">action_space</span>          <span class="c1"># property , SpaceBase : RLWorkerが受け取るaction_spaceを返します</span>
<span class="bp">self</span><span class="o">.</span><span class="n">get_invalid_actions</span><span class="p">()</span> <span class="c1"># function , List[RLAction] : 有効でないアクションを返します(離散限定)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">sample_action</span><span class="p">()</span>       <span class="c1"># function , RLAction : ランダムなアクションを返します</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">※v0.15.0からRLWorkerを直接継承する方法に変更しました</div>
<div class="line">※v0.16.0からInfoが戻り値ではなく、内部変数になりました</div>
<div class="line">※v0.19.0 より <cite>__init__</cite> の使用は非推奨となりました。代わりにon_setupを使ってください。</div>
<div class="line"><br /></div>
<div class="line">各種情報は WorkerRun から取り出して使います。</div>
<div class="line">情報の例は以下です。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyWorker</span><span class="p">(</span><span class="n">RLWorker</span><span class="p">):</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">state</span>           <span class="c1"># 初期状態</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">player_index</span>    <span class="c1"># 初期プレイヤーのindex</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">invalid_actions</span> <span class="c1"># 初期有効ではないアクションリスト</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">state</span>           <span class="c1"># 状態</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">player_index</span>    <span class="c1"># プレイヤーのindex</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">invalid_actions</span> <span class="c1"># 有効ではないアクションリスト</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="s2">&quot;WorkerRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">state</span>           <span class="c1"># policy時のworker.state</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">next_state</span>      <span class="c1"># step後の状態</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">action</span>          <span class="c1"># policyで返したアクション</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">reward</span>          <span class="c1"># step後の即時報酬</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">done</span>            <span class="c1"># step後に終了フラグが立ったか</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">terminated</span>      <span class="c1"># step後にenvが終了フラグを立てたか</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">player_index</span>    <span class="c1"># 次のプレイヤーのindex</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">invalid_action</span>       <span class="c1"># policy時のworker.invalid_action</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">next_invalid_actions</span> <span class="c1"># step後の有効ではないアクションリスト</span>

   <span class="k">def</span><span class="w"> </span><span class="nf">render_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>  <span class="c1"># 及び render_rgb_array</span>
      <span class="c1"># policy -&gt; render -&gt; env.step -&gt; on_step -&gt; policy</span>
      <span class="c1"># 想定する役割は、policy直後の状態の表示 + 前の状態の結果を表示</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">state</span>           <span class="c1"># policy時の状態</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">prev_state</span>      <span class="c1"># policy時の1つ前の状態</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">action</span>          <span class="c1"># policyで返したアクション</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">player_index</span>    <span class="c1"># プレイヤーのindex</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">invalid_actions</span>       <span class="c1"># policy時の有効ではないアクションリスト</span>
      <span class="n">worker</span><span class="o">.</span><span class="n">prev_invalid_actions</span>  <span class="c1"># policy時の1つ前の有効ではないアクションリスト</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">※v0.19.0 より on_step 内の prev_state/state → state/next_state に変更になりました</div>
</div>
</section>
</section>
<section id="id4">
<h2>3. 自作アルゴリズムの登録<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">以下で登録します。</div>
<div class="line">第2引数以降の entry_point は、<cite>モジュールパス + ':' + クラス名</cite> で記載します。</div>
<div class="line">モジュールパスは <cite>importlib.import_module</cite> で呼び出せる形式である必要があります。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">register</span>
<span class="n">register</span><span class="p">(</span>
   <span class="n">MyConfig</span><span class="p">(),</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyMemory&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyParameter&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyTrainer&quot;</span><span class="p">,</span>
   <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:MyWorker&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>4. 型ヒント<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">動作に影響ないですが、可能な限り型ヒントが表示されるようにしています。</div>
<div class="line">※VSCodeを想定しています</div>
<div class="line">RLConfigとRLWorkerはimport先を変えることで型アノテーションが指定された状態になります。</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># from srl.rl.config import RLConfig</span>
<span class="c1"># from srl.rl.worker import RLWorker</span>
<span class="c1"># ↓</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.algorithms.base_dqn</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLConfig</span><span class="p">,</span> <span class="n">RLWorker</span>

<span class="c1"># srl.base.rl.algorithms.base_XX の XX の部分を変更する事でアルゴリズムに合った型に変更できます</span>
<span class="c1"># XX の種類についてはソースコードを見てください。</span>
</pre></div>
</div>
<p>また、ジェネリック型を追加する事で各クラスの型を追加できます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># RLMemory[TConfig]</span>
<span class="c1">#   TConfig : RLConfigを継承したクラス</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Memoryr</span><span class="p">(</span><span class="n">RLMemory</span><span class="p">[</span><span class="n">Config</span><span class="p">]):</span>
   <span class="k">pass</span>

<span class="c1"># RLParameter[TConfig]</span>
<span class="c1">#   TConfig : RLConfigを継承したクラス</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Parameter</span><span class="p">(</span><span class="n">RLParameter</span><span class="p">[</span><span class="n">Config</span><span class="p">]):</span>
   <span class="k">pass</span>

<span class="c1"># RLTrainer[TConfig, TParameter, TMemory]</span>
<span class="c1">#   TConfig    : RLConfigを継承したクラス</span>
<span class="c1">#   TParameter : RLParameterを継承したクラス</span>
<span class="c1">#   TMemory    : RLMemoryを継承したクラス</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Trainer</span><span class="p">(</span><span class="n">RLTrainer</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Memory</span><span class="p">]):</span>
   <span class="k">pass</span>

<span class="c1"># RLWorker[TConfig, TParameter]</span>
<span class="c1">#   TConfig    : RLConfigを継承したクラス</span>
<span class="c1">#   TParameter : RLParameterを継承したクラス</span>
<span class="c1">#   TMemory    : RLMemoryを継承したクラス</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Worker</span><span class="p">(</span><span class="n">RLWorker</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Memory</span><span class="p">]):</span>
   <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="q">
<h2>5. 実装例(Q学習)<a class="headerlink" href="#q" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.define</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLBaseActTypes</span><span class="p">,</span> <span class="n">RLBaseObsTypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLMemory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLParameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">register</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLTrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.rl.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLWorker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.spaces.array_discrete</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayDiscreteSpace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">srl.base.spaces.discrete</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiscreteSpace</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">RLConfig</span><span class="p">[</span><span class="n">DiscreteSpace</span><span class="p">,</span> <span class="n">ArrayDiscreteSpace</span><span class="p">]):</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">test_epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_action_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseActTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseActTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLBaseObsTypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RLBaseObsTypes</span><span class="o">.</span><span class="n">DISCRETE</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MyRL&quot;</span>


<span class="c1"># 継承する場合</span>
<span class="c1"># from srl.rl.memories.single_use_buffer import RLSingleUseBuffer</span>
<span class="c1"># class Memory(RLSingleUseBuffer):</span>
<span class="c1">#     pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">(</span><span class="n">RLMemory</span><span class="p">[</span><span class="n">Config</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_worker_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trainer_recv_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">serialized</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Parameter</span><span class="p">(</span><span class="n">RLParameter</span><span class="p">[</span><span class="n">Config</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Q学習用のテーブル</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>

    <span class="c1"># Q値を取得する関数</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Trainer</span><span class="p">(</span><span class="n">RLTrainer</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Memory</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">batches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">td_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="c1"># 各batch毎にQテーブルを更新する</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
            <span class="n">n_s</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;next_state&quot;</span><span class="p">]</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;done&quot;</span><span class="p">]</span>

            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="n">n_s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_q</span><span class="p">)</span>

            <span class="n">td_error</span> <span class="o">=</span> <span class="n">target_q</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
            <span class="n">q</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="n">td_error</span>

            <span class="n">td_error</span> <span class="o">+=</span> <span class="n">td_error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 学習回数</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">td_error</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

        <span class="c1"># 学習結果(任意)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;td_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">td_error</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Worker</span><span class="p">(</span><span class="n">RLWorker</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Memory</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="c1"># 学習中かどうかで探索率を変える</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_epsilon</span>

        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
            <span class="c1"># epsilonより低いならランダムに移動</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_action</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

            <span class="c1"># 最大値を選ぶ（複数あればランダム）</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="s2">&quot;next_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">next_state</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">reward</span><span class="p">,</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">worker</span><span class="o">.</span><span class="n">terminated</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># 強化学習の可視化用、今回ですとQテーブルを表示しています。</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">get_action_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="n">maxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">maxa</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_to_str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="si">:</span><span class="s2">7.5f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="c1"># ---------------------------------</span>
<span class="c1"># 登録</span>
<span class="c1"># ---------------------------------</span>
<span class="n">register</span><span class="p">(</span>
    <span class="n">Config</span><span class="p">(),</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Memory&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Parameter&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Trainer&quot;</span><span class="p">,</span>
    <span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;:Worker&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">srl.test.rl</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_rl</span>

    <span class="n">test_rl</span><span class="p">(</span><span class="n">Config</span><span class="p">())</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># --- Grid環境の学習</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">srl</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">srl</span><span class="o">.</span><span class="n">Runner</span><span class="p">(</span><span class="n">srl</span><span class="o">.</span><span class="n">EnvConfig</span><span class="p">(</span><span class="s2">&quot;Grid&quot;</span><span class="p">),</span> <span class="n">Config</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">))</span>

    <span class="c1"># --- train</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">train_mp</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># --- test</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">max_episodes</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;100エピソードの平均結果&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>

    <span class="n">runner</span><span class="o">.</span><span class="n">render_terminal</span><span class="p">()</span>

    <span class="n">runner</span><span class="o">.</span><span class="n">animation_save_gif</span><span class="p">(</span><span class="s2">&quot;_MyRL-Grid.gif&quot;</span><span class="p">,</span> <span class="n">render_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># test()</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>renderの表示例</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>100エピソードの平均結果 0.7347999999999999
......
.   G.
. . X.
.P   .
......

←: 0.15227
↓: 0.13825
→: 0.08833
*↑: 0.36559
### 0
state: 1,3
action : 3(↑)
rewards:[0.000]
env   {}
work0 {}
......
.   G.
.P. X.
.S   .
......

←: 0.24042
↓: 0.17950
→: 0.23959
*↑: 0.48550
### 1
state: 1,2
action : 3(↑)
rewards:[-0.040]
env   {}
work0 {}
......
.P  G.
. . X.
.S   .
......

←: 0.30830
↓: 0.25582
*→: 0.60909
↑: 0.31496
### 2
state: 1,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
.P  G.
. . X.
.S   .
......

←: 0.30830
↓: 0.25582
*→: 0.60909
↑: 0.31496
### 3
state: 1,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
.   G.
.P. X.
.S   .
......

←: 0.24042
↓: 0.17950
→: 0.23959
*↑: 0.48550
### 4
state: 1,2
action : 3(↑)
rewards:[-0.040]
env   {}
work0 {}
......
.   G.
.P. X.
.S   .
......

←: 0.24042
↓: 0.17950
→: 0.23959
*↑: 0.48550
### 5
state: 1,2
action : 3(↑)
rewards:[-0.040]
env   {}
work0 {}
......
.P  G.
. . X.
.S   .
......

←: 0.30830
↓: 0.25582
*→: 0.60909
↑: 0.31496
### 6
state: 1,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
.P  G.
. . X.
.S   .
......

←: 0.30830
↓: 0.25582
*→: 0.60909
↑: 0.31496
### 7
state: 1,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
. P G.
. . X.
.S   .
......

←: 0.33411
↓: 0.40200
*→: 0.76411
↑: 0.41102
### 8
state: 2,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
.  PG.
. . X.
.S   .
......

←: 0.42417
↓: 0.36094
*→: 0.92805
↑: 0.54881
### 9
state: 3,1
action : 2(→)
rewards:[-0.040]
env   {}
work0 {}
......
.   P.
. . X.
.S   .
......

←: 0.42417
↓: 0.36094
*→: 0.92805
↑: 0.54881
### 10, done()
state: 4,1
action : 2(→)
rewards:[1.000]
env   {}
work0 {}
</pre></div>
</div>
<img alt="../_images/custom_algorithm4.gif" src="../_images/custom_algorithm4.gif" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom_env.html" class="btn btn-neutral float-left" title="Making a Custom environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="framework_detail.html" class="btn btn-neutral float-right" title="Detailed Framework" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, poco.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>